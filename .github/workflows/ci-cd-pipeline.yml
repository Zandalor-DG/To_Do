name: CI/CD

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
env:
  GRADLE_VERSION: '8.13.1'
  ANDROID_COMPILE_SDK: 36
  ANDROID_BUILD_TOOLS: '36.0.0'
  ANDROID_MIN_SDK: 24
  ANDROID_TARGET_SDK: 36
  KOTLIN_VERSION: '2.2.21'

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platforms;android-36" \
            "build-tools;36.0.0" \
            "platform-tools" \
            "cmdline-tools;latest"

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run unit tests
        run: ./gradlew testDebugUnitTest

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            app/build/reports/
            app/build/outputs/androidTest-results/
  dev:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/dev')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platforms;android-36" \
            "build-tools;36.0.0"

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Build debug APK
        run: ./gradlew assembleDebug

      - name: Build debug AAB
        run: ./gradlew bundleDebug

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: | 
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/debug/*.apk
  main:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Create signing.properties
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > app/keystore.jks
          cat << EOF > keystore.properties
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=keystore.jks
          EOF

      - name: Build release APK
        run: ./gradlew assembleRelease

      - name: Build release AAB (–¥–ª—è Google Play)
        run: ./gradlew bundleRelease

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab

      - name: Run lint
        run: ./gradlew lintDebug
  deploy-dev:
    runs-on: ubuntu-latest
    needs: dev

    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            app/build/outputs/bundle/debug/*.aab
            app/build/outputs/apk/debug/*.apk
          generate_release_notes: true

      - name: Deploy to Google Play
        if: needs.check-secrets.outputs.has-google-play-key == 'true' && (github.event.inputs.store == 'google' || github.event.inputs.store == 'both')
        run: |
          echo "üì§ Uploading to Google Play..."

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º python-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
          python3 scripts/upload_to_google_play.py \
            --package-name "${{ secrets.PACKAGE_NAME }}" \
            --aab-path "app/build/outputs/bundle/debug/app-debug.aab" \
            --track internal \
            --service-account-key "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_KEY }}"

      - name: Deploy to RuStore
        if: needs.check-secrets.outputs.has-rustore-creds == 'true' && (github.event.inputs.store == 'rustore' || github.event.inputs.store == 'both')
        run: |
          echo "üì§ Uploading to RuStore..."

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π CLI RuStore –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
          if command -v rustore-cli &> /dev/null; then
            rustore-cli upload \
              --apk "app/build/outputs/apk/debug/app-debug.apk" \
              --login "${{ secrets.RUSTORE_LOGIN }}" \
              --password "${{ secrets.RUSTORE_PASSWORD }}" \
              --app-id "${{ secrets.RUSTORE_APP_ID }}" \
              --track internal
          else
            echo "‚ö†Ô∏è  RuStore CLI not installed, using API directly..."
            # –í—ã–∑–æ–≤ API –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –≤—ã—à–µ
          fi

      # 5. –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
      - name: Send notifications
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment successful!"
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Slack/Telegram
          else
            echo "‚ùå Deployment failed!"
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–ª–µ—Ä—Ç
          fi

  deploy-main:
    runs-on: ubuntu-latest
    needs: main

    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            app/build/outputs/bundle/release/*.aab
            app/build/outputs/apk/release/*.apk
          generate_release_notes: true

      - name: Deploy to Google Play
        if: needs.check-secrets.outputs.has-google-play-key == 'true' && (github.event.inputs.store == 'google' || github.event.inputs.store == 'both')
        run: |
          echo "üì§ Uploading to Google Play..."

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º python-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
          python3 scripts/upload_to_google_play.py \
            --package-name "${{ secrets.PACKAGE_NAME }}" \
            --aab-path "app/build/outputs/bundle/release/app-release.aab" \
            --track internal \
            --service-account-key "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_KEY }}"

      - name: Deploy to RuStore
        if: needs.check-secrets.outputs.has-rustore-creds == 'true' && (github.event.inputs.store == 'rustore' || github.event.inputs.store == 'both')
        run: |
          echo "üì§ Uploading to RuStore..."

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π CLI RuStore –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
          if command -v rustore-cli &> /dev/null; then
            rustore-cli upload \
              --apk "app/build/outputs/apk/release/app-release.apk" \
              --login "${{ secrets.RUSTORE_LOGIN }}" \
              --password "${{ secrets.RUSTORE_PASSWORD }}" \
              --app-id "${{ secrets.RUSTORE_APP_ID }}" \
              --track internal
          else
            echo "‚ö†Ô∏è  RuStore CLI not installed, using API directly..."
            # –í—ã–∑–æ–≤ API –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –≤—ã—à–µ
          fi

      # 5. –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
      - name: Send notifications
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment successful!"
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Slack/Telegram
          else
            echo "‚ùå Deployment failed!"
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–ª–µ—Ä—Ç
          fi
