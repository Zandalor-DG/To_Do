name: Deploy to stores

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Create GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            app/build/outputs/bundle/release/*.aab
            app/build/outputs/apk/release/*.apk
          generate_release_notes: true

      - name: Deploy to Google Play
        if: needs.check-secrets.outputs.has-google-play-key == 'true' && (github.event.inputs.store == 'google' || github.event.inputs.store == 'both')
        run: |
          echo "üì§ Uploading to Google Play..."

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º python-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
          python3 scripts/upload_to_google_play.py \
            --package-name "${{ secrets.PACKAGE_NAME }}" \
            --aab-path "app/build/outputs/bundle/release/app-release.aab" \
            --track internal \
            --service-account-key "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_KEY }}"

      - name: Deploy to RuStore
        if: needs.check-secrets.outputs.has-rustore-creds == 'true' && (github.event.inputs.store == 'rustore' || github.event.inputs.store == 'both')
        run: |
          echo "üì§ Uploading to RuStore..."

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π CLI RuStore –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
          if command -v rustore-cli &> /dev/null; then
            rustore-cli upload \
              --apk "app/build/outputs/apk/release/app-release.apk" \
              --login "${{ secrets.RUSTORE_LOGIN }}" \
              --password "${{ secrets.RUSTORE_PASSWORD }}" \
              --app-id "${{ secrets.RUSTORE_APP_ID }}" \
              --track internal
          else
            echo "‚ö†Ô∏è  RuStore CLI not installed, using API directly..."
            # –í—ã–∑–æ–≤ API –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –≤—ã—à–µ
          fi

      # 5. –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
      - name: Send notifications
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment successful!"
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Slack/Telegram
          else
            echo "‚ùå Deployment failed!"
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–ª–µ—Ä—Ç
          fi
